# RelayX Architecture Diagram

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         PHONE NETWORK (Twilio)                      â”‚
â”‚                                                                      â”‚
â”‚  Customer Phone  â†â”€â”€â”€â”€ Twilio Cloud â”€â”€â”€â”€â†’  TwiML/WebSocket         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ 1. Call initiated via API
                           â”‚ 2. Audio streams via WebSocket
                           â”‚ 3. Status callbacks
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        YOUR INFRASTRUCTURE                           â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    FastAPI Backend                           â”‚  â”‚
â”‚  â”‚                    (Port 8000)                               â”‚  â”‚
â”‚  â”‚                                                              â”‚  â”‚
â”‚  â”‚  â€¢ POST /calls/outbound â”€â”€â†’ Initiate call                   â”‚  â”‚
â”‚  â”‚  â€¢ GET  /calls          â”€â”€â†’ List calls                      â”‚  â”‚
â”‚  â”‚  â€¢ POST /agents         â”€â”€â†’ Create AI agent                 â”‚  â”‚
â”‚  â”‚  â€¢ GET  /health         â”€â”€â†’ System health                   â”‚  â”‚
â”‚  â”‚                                                              â”‚  â”‚
â”‚  â”‚  Triggers Twilio API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚               â”‚                                     â”‚               â”‚
â”‚               â”‚ Reads/Writes                       â”‚               â”‚
â”‚               â–¼                                     â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                Voice Gateway                     â”‚           â”‚  â”‚
â”‚  â”‚                (Port 8001)                       â”‚           â”‚  â”‚
â”‚  â”‚                                                  â”‚           â”‚  â”‚
â”‚  â”‚  WebSocket Handler (Twilio Media Stream)        â”‚           â”‚  â”‚
â”‚  â”‚                                                  â”‚           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚           â”‚  â”‚
â”‚  â”‚  â”‚     REAL-TIME AI PIPELINE                 â”‚ â”‚           â”‚  â”‚
â”‚  â”‚  â”‚                                            â”‚ â”‚           â”‚  â”‚
â”‚  â”‚  â”‚  1. Receive audio (mulaw from Twilio)     â”‚ â”‚           â”‚  â”‚
â”‚  â”‚  â”‚           â–¼                                â”‚ â”‚           â”‚  â”‚
â”‚  â”‚  â”‚  2. Buffer & decode                       â”‚ â”‚           â”‚  â”‚
â”‚  â”‚  â”‚           â–¼                                â”‚ â”‚           â”‚  â”‚
â”‚  â”‚  â”‚  3. Whisper STT â†’ Text                    â”‚ â”‚           â”‚  â”‚
â”‚  â”‚  â”‚           â–¼                                â”‚ â”‚           â”‚  â”‚
â”‚  â”‚  â”‚  4. Get conversation history from DB      â”‚ â”‚           â”‚  â”‚
â”‚  â”‚  â”‚           â–¼                                â”‚ â”‚           â”‚  â”‚
â”‚  â”‚  â”‚  5. Send to LLM (via ngrok)               â”‚ â”‚           â”‚  â”‚
â”‚  â”‚  â”‚           â–¼                                â”‚ â”‚           â”‚  â”‚
â”‚  â”‚  â”‚  6. Get AI response text                  â”‚ â”‚           â”‚  â”‚
â”‚  â”‚  â”‚           â–¼                                â”‚ â”‚           â”‚  â”‚
â”‚  â”‚  â”‚  7. Coqui TTS â†’ Audio (WAV)               â”‚ â”‚           â”‚  â”‚
â”‚  â”‚  â”‚           â–¼                                â”‚ â”‚           â”‚  â”‚
â”‚  â”‚  â”‚  8. Convert to mulaw & stream to Twilio   â”‚ â”‚           â”‚  â”‚
â”‚  â”‚  â”‚           â–¼                                â”‚ â”‚           â”‚  â”‚
â”‚  â”‚  â”‚  9. Save transcript to DB                 â”‚ â”‚           â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚           â”‚  â”‚
â”‚  â”‚                                                  â”‚           â”‚  â”‚
â”‚  â”‚  Exposed via ngrok (wss://)  â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ Database Operations
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Supabase (Postgres)                              â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚   agents     â”‚  â”‚    calls     â”‚  â”‚ transcripts  â”‚             â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚             â”‚
â”‚  â”‚ â€¢ id         â”‚  â”‚ â€¢ id         â”‚  â”‚ â€¢ id         â”‚             â”‚
â”‚  â”‚ â€¢ name       â”‚  â”‚ â€¢ agent_id   â”‚  â”‚ â€¢ call_id    â”‚             â”‚
â”‚  â”‚ â€¢ prompt     â”‚  â”‚ â€¢ to_number  â”‚  â”‚ â€¢ speaker    â”‚             â”‚
â”‚  â”‚ â€¢ settings   â”‚  â”‚ â€¢ status     â”‚  â”‚ â€¢ text       â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â€¢ duration   â”‚  â”‚ â€¢ timestamp  â”‚             â”‚
â”‚                    â”‚ â€¢ metadata   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚      call_analysis (future)      â”‚                              â”‚
â”‚  â”‚  â€¢ summary                        â”‚                              â”‚
â”‚  â”‚  â€¢ key_points                     â”‚                              â”‚
â”‚  â”‚  â€¢ sentiment                      â”‚                              â”‚
â”‚  â”‚  â€¢ outcome                        â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LLM Infrastructure                                â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚           Ollama (Local)                               â”‚         â”‚
â”‚  â”‚           Port 11434                                   â”‚         â”‚
â”‚  â”‚                                                        â”‚         â”‚
â”‚  â”‚   Model: llama3:8b                                     â”‚         â”‚
â”‚  â”‚   API: /api/chat                                       â”‚         â”‚
â”‚  â”‚                                                        â”‚         â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚         â”‚
â”‚  â”‚   â”‚     Conversation Processing          â”‚            â”‚         â”‚
â”‚  â”‚   â”‚                                      â”‚            â”‚         â”‚
â”‚  â”‚   â”‚  Input:  User message + history     â”‚            â”‚         â”‚
â”‚  â”‚   â”‚  Output: AI response text           â”‚            â”‚         â”‚
â”‚  â”‚   â”‚  Params: temperature, max_tokens    â”‚            â”‚         â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚         â”‚
â”‚  â”‚                                                        â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                           â–²                                          â”‚
â”‚                           â”‚                                          â”‚
â”‚                           â”‚ Exposed via ngrok                        â”‚
â”‚                           â”‚                                          â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                    â”‚    ngrok     â”‚                                 â”‚
â”‚                    â”‚              â”‚                                 â”‚
â”‚                    â”‚ Public URL   â”‚                                 â”‚
â”‚                    â”‚ https://...  â”‚                                 â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Request Flow: Outbound Call

```
User Request
    â”‚
    â–¼
1. POST /calls/outbound
    â”‚
    â–¼
2. Backend creates call record in DB
    â”‚
    â–¼
3. Backend triggers Twilio API
    â”‚
    â–¼
4. Twilio dials customer number
    â”‚
    â–¼
5. Customer answers â†’ Twilio requests TwiML
    â”‚
    â–¼
6. Backend returns TwiML with <Stream> directive
    â”‚
    â–¼
7. Twilio establishes WebSocket to Voice Gateway
    â”‚
    â–¼
8. Voice Gateway sends greeting (TTS)
    â”‚
    â–¼
9. CONVERSATION LOOP:
    â”‚
    â”œâ”€â†’ Customer speaks
    â”‚       â–¼
    â”œâ”€â†’ Audio buffered
    â”‚       â–¼
    â”œâ”€â†’ Whisper STT â†’ Text
    â”‚       â–¼
    â”œâ”€â†’ Save to DB (transcripts)
    â”‚       â–¼
    â”œâ”€â†’ Get conversation history
    â”‚       â–¼
    â”œâ”€â†’ Send to LLM (via ngrok)
    â”‚       â–¼
    â”œâ”€â†’ LLM responds with text
    â”‚       â–¼
    â”œâ”€â†’ Save to DB (transcripts)
    â”‚       â–¼
    â”œâ”€â†’ Coqui TTS â†’ Audio
    â”‚       â–¼
    â””â”€â†’ Stream audio to Twilio â†’ Customer hears
    â”‚
    â–¼
10. Call ends â†’ Update DB (status, duration)
    â”‚
    â–¼
11. (Future) Post-call analysis runs
```

## Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Customer   â”‚
â”‚    Phone     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Voice (audio)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Twilio     â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Cloud      â”‚              â”‚ HTTP Status Callbacks
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
       â”‚                      â–¼
       â”‚ WebSocket         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ (mulaw audio)     â”‚   Backend    â”‚
       â–¼                   â”‚   (8000)     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚    Voice     â”‚                  â”‚
â”‚   Gateway    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ Trigger Call
â”‚   (8001)     â”‚                  â”‚ Get Agent Config
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
       â”‚                          â–¼
       â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ Store/Retrieve    â”‚  Supabase    â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  (Postgres)  â”‚
       â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Generate Response
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Ollama     â”‚
â”‚  (via ngrok) â”‚
â”‚   llama3:8b  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Component Responsibilities

### Backend (FastAPI)
- ğŸ¯ **Purpose:** API gateway & Twilio orchestration
- ğŸ“Œ **Port:** 8000
- âœ… **Features:**
  - REST API endpoints
  - Agent CRUD operations
  - Call initiation via Twilio API
  - Call status tracking
  - Database operations

### Voice Gateway (FastAPI + WebSocket)
- ğŸ¯ **Purpose:** Real-time voice AI processing
- ğŸ“Œ **Port:** 8001
- âœ… **Features:**
  - Twilio Media Stream WebSocket handler
  - Audio buffering & format conversion
  - STT (Whisper) integration
  - LLM conversation management
  - TTS (Coqui) generation
  - Transcript storage

### Shared Services
- ğŸ—„ï¸ **database.py** - Supabase operations
- ğŸ§  **llm_client.py** - Ollama LLM communication
- ğŸ™ï¸ **stt_client.py** - Whisper speech-to-text
- ğŸ”Š **tts_client.py** - Coqui text-to-speech

### Infrastructure
- ğŸ³ **Docker Compose** - Container orchestration
- ğŸŒ **ngrok** - Exposes local services publicly
- ğŸ“Š **Supabase** - Managed Postgres database
- â˜ï¸ **Twilio** - Telephony infrastructure

## Network Ports

| Service | Port | Exposed | Protocol |
|---------|------|---------|----------|
| Backend | 8000 | Localhost | HTTP |
| Voice Gateway | 8001 | ngrok (wss) | HTTP/WS |
| Ollama | 11434 | ngrok (https) | HTTP |
| Supabase | 5432 | Cloud | Postgres |
| Twilio | N/A | Cloud | HTTP/WS |

## Security Layers

```
Internet
   â”‚
   â–¼
Twilio (trusted)
   â”‚
   â–¼
ngrok tunnel (HTTPS/WSS)
   â”‚
   â–¼
Voice Gateway (local)
   â”‚
   â–¼
Supabase (auth token)
   â”‚
   â–¼
Database (RLS policies)
```

## Scalability Considerations

### Current (MVP)
- Single instance of each service
- Local LLM (one machine)
- Synchronous processing

### Future (Production)
- Load balanced backend/voice gateway
- Cloud-hosted LLM (or distributed Ollama)
- Async task queue for post-call analysis
- CDN for static assets
- Database read replicas
- Redis for session management

---

**This architecture balances simplicity for MVP with extensibility for production.**
